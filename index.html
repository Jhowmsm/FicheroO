<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generar .add.WIP desde una carpeta de archivos PDF</title>
  <!-- Aquí enlazamos el CSS externo -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h1>Generar archivo .add.WIP desde una carpeta de archivos PDF</h1>

    <p>Selecciona una carpeta que contenga archivos PDF con el nombre esperado (ej: 20250115_LAN572_SCL-BOG_ECNBN_SALAS_DOCUMENTO.pdf).</p>

    <label for="folderInput">Seleccionar carpeta:</label>
    <input type="file" id="folderInput" webkitdirectory directory multiple />

    <label for="nombreCarpeta">Nombre de carpeta (se detectará automáticamente):</label>
    <input type="text" id="nombreCarpeta" placeholder="Ejemplo: Carpeta1" readonly />

    <button onclick="procesarYGuardar()">Generar y guardar archivo</button>

    <div id="alerta" class="alert"></div>
  </div>

  <script>
    const folderInput = document.getElementById('folderInput');
    const nombreCarpetaInput = document.getElementById('nombreCarpeta');
    const alertaDiv = document.getElementById('alerta');

    folderInput.addEventListener('change', () => {
      alertaDiv.style.display = 'none';
      const files = folderInput.files;
      if (files.length) {
        const rutaRelativa = files[0].webkitRelativePath;
        const nombreCarpeta = rutaRelativa.split('/')[0];
        nombreCarpetaInput.value = nombreCarpeta;
      } else {
        nombreCarpetaInput.value = '';
      }
    });

    async function procesarYGuardar() {
      alertaDiv.style.display = 'none';
      const files = folderInput.files;

      if (!files.length) {
        mostrarAlerta('Selecciona una carpeta que contenga archivos PDF');
        return;
      }

      const nombreCarpeta = nombreCarpetaInput.value.trim();
      if (!nombreCarpeta) {
        mostrarAlerta('No se pudo detectar el nombre de la carpeta');
        return;
      }

      const campos_fijos = {
        campo_1: '"ME598"',
        campo_2: '"59580"',
        campo_3: '"595801"'
      };

      let datos = [];

      for (const file of files) {
        if (!file.name.toLowerCase().endsWith('.pdf')) continue;

        const nombre = file.name.replace(/\.[^/.]+$/, "");
        const partes = nombre.split("_");

        if (partes.length >= 6) {
          const fila = [
            campos_fijos.campo_1,
            `"${nombreCarpeta}"`,
            '""',
            campos_fijos.campo_2,
            campos_fijos.campo_3,
            '""',
            '""',
            `"${partes[1]}"`,
            `"${partes[2]}"`,
            '""',
            `"${partes[5]}"`,
            '""',
            '""',
            '""',
            `"${partes[3]}"`,
            `"${partes[4]}"`,
            '""',
            '""',
            '""',
            '""'
          ];
          datos.push(fila.join(" "));
        }
      }

      if (datos.length === 0) {
        mostrarAlerta("No se encontraron archivos PDF válidos en la carpeta.");
        return;
      }

      const ahora = new Date();
      const fecha = ahora.toLocaleDateString('en-US', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '');
      const hora = ahora.toTimeString().slice(0, 8).replace(/:/g, '');

      const nombreArchivo = `ME-ME-FILE-${fecha}_${hora}.add.WIP`;
      const contenido = datos.join("\n");

      try {
        await guardarEnCarpetaSKP(nombreArchivo, contenido);
      } catch (err) {
        mostrarAlerta('Error guardando archivo: ' + err.message);
      }
    }

    function mostrarAlerta(mensaje) {
      alertaDiv.textContent = mensaje;
      alertaDiv.style.display = 'block';
    }

    async function guardarEnCarpetaSKP(nombreArchivo, contenido) {
      const rootHandle = await window.showDirectoryPicker();

      const skpHandle = await rootHandle.getDirectoryHandle('SKP', { create: true });

      const fileHandle = await skpHandle.getFileHandle(nombreArchivo, { create: true });

      const writable = await fileHandle.createWritable();
      await writable.write(contenido);
      await writable.close();

      alert('Archivo guardado en carpeta SKP dentro de la carpeta seleccionada.');
    }
  </script>
</body>
</html>
